---
title: "Take home Exercise 3 - 4 Feb 2022"
description: |
  Animation of graphs in R
author:
  - name: Frostbear 
    url: https://sg.linkedin.com/in/farahfoo
    affiliation: SMU Masters in IT business (Fintech and Analytics)
    affiliation_url: https://scis.smu.edu.sg/master-it-business
date: "`r Sys.Date()`"
output: distill::distill_article
---

# Context of Exercise
Using previous age-sex pyramid based on 2021 data, to apply appropriate interactivity and animation methods to design an age-sex pyramid based data visualisation to show the changes of demographic structure of Singapore by age cohort and gender between 2000-2020 at planning area level. The data set used is entitle Singapore Residents by Planning Area / Subzone, Age Group, Sex and Type of Dwelling, June 2000-2010 and Singapore Residents by Planning Area / Subzone, Age Group, Sex and Type of Dwelling, June 2011-2020, from Department of Statistics home page.


# Installing and loading packages required for Age-Sex pyramid

```{r echo = TRUE}  
packages = c('tidyverse', 'readxl', 'ggthemes')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

# Loading data using _csv command
```{r echo = TRUE, warning = FALSE, message = FALSE}
pop_data <- read_csv("data/respopagesextod2021.csv")
glimpse (data)

```


# Adding Factor levels to AG field

To sort the age-sex pyramid using Age Group, we need to classify the AG field as Factor

```{r echo = TRUE, warning = FALSE, message = FALSE}

pop_data$AG <- factor(pop_data$AG, levels = unique(pop_data$AG))
```


# Summarising the data into the required buckets
```{r echo = TRUE, warning = FALSE, message = FALSE}

summary_sex <- pop_data %>%
  group_by(AG, Sex) %>%
  summarise(Pop = sum(Pop)) %>%
  ungroup()

head (summary_sex,5)
```


# Plotting double geom_bar Age-sex pyramid
```{r echo = TRUE, warning = FALSE, message = FALSE}

ggplot(summary_sex, aes(x=AG)) +
  geom_bar(data=summary_sex[summary_sex$Sex=="Males",], aes(y=Pop*-1), stat="identity", fill="blue") +
  geom_bar(data=summary_sex[summary_sex$Sex=="Females",], aes(y=Pop), stat="identity", fill="pink") +
  geom_hline(yintercept=0, colour="white", lwd=1)+
coord_flip () +
scale_y_continuous(breaks = seq(-160000,160000,40000), labels = function(v) ifelse(abs(v)>=1000,paste0(abs(v)/1000, "K"), abs(v))) +
  labs(y="Population", x="Gender") +
  ggtitle("                        Male                                                Female")


```

# Building base graph for 20 years of population data

For animation of population across time, data source can be found  [here at singstat website](https://www.singstat.gov.sg/find-data/search-by-theme/population/geographic-distribution/latest-data). 

* Download 2 sets of data, 1) year 2000 to 2010, and 2) year 2011 to 2020 and combine into 1 set of data.

* Check if the header has been copied into the data set by finding out the unique time brackets


```{r echo = TRUE, warning = FALSE, message = FALSE}
year2000 <- read_csv("data/respopagesextod2000to2010.csv")
year2011 <- read_csv("data/respopagesextod2011to2020.csv") 

head (year2000,3)
head (year2011,3)

# Since columns are the same, we can combine the 2 files into 1 file for processing

combined <- rbind(year2000,year2011)
unique(combined$Time)

# write_csv(combined, "combined.csv")

# in the Time column, there are only numbers, hence the row header was not copied into the data
```

# Adding Factor levels to Age group field

To sort the age-sex pyramid using Age Group, we need to classify the AG field as Factor

```{r echo = TRUE, warning = FALSE, message = FALSE}

combined$AG <- factor(combined$AG, levels = unique(combined$AG))
```

# Summarising data by Age Group, Sex and Time 

To plot the graph over the different years, we need to call out the Time field as a column (variable)

```{r echo = TRUE, warning = FALSE, message = FALSE}

summary_sex_20 <- combined %>%
  group_by(AG, Sex, Time) %>%
  summarise(Pop = sum(Pop)) %>%
  ungroup()

head (summary_sex_20,5)
```

# Plotting double geom_bar Age-sex pyramid for 20 years

Using the individual Age-sex pyramid from above (plotted for year 2021), we re-use the code to plot out 20 pyramid graphs, 1 graph for each year. 

```{r echo=TRUE, fig.height=20, fig.width=10, message=FALSE, warning=FALSE}

ggplot(summary_sex_20, aes(x=AG)) +
  geom_bar(data=summary_sex_20[summary_sex_20$Sex=="Males",], aes(y=Pop*-1), stat="identity", fill="blue") +
  geom_bar(data=summary_sex_20[summary_sex_20$Sex=="Females",], aes(y=Pop), stat="identity", fill="pink") +
  geom_hline(yintercept=0, colour="white", lwd=1)+
  
coord_flip () +
  
scale_y_continuous(breaks = seq(-160000,160000,40000), labels = function(v) ifelse(abs(v)>=1000,paste0(abs(v)/1000, "K"), abs(v))) +
  
  labs(title = "Age-Sex Population Pyramid, Singapore 2021", 
   caption = 'Data Source: Department of Statistics (June 2021)',
   y = "Population", x = "Gender") + 
  
  theme_bw() +
   theme(legend.position = "none")+
  theme(plot.title = element_text(size=16))+
  theme(plot.subtitle = element_text(size=12))+
  
facet_wrap(. ~ `Time`,ncol=4)

```

It is clear from the 20 graphs displayed, that the difference in population year on year is not clear. To show more clarity, we use the year as base to transition the graph in 1 frame in the next section. 


# Using gganimate
but first, we enhance the graph by 

*adding title
*caption 
*theme
*find out the maximum and minimum values of the population to set the chart axis to ensure all the values will be captured properly.

### Activating gganimate as it will be used for the animation of the age-sex pyramid over the 20 years

We call out the package required which is ggaminate.

```{r echo = TRUE}  
packages = c('gganimate')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

### Then we find out the max and min values of the population set.
```{r echo=TRUE, message=FALSE, warning=FALSE}
max(summary_sex_20$Pop)
min(summary_sex_20$Pop)
```

### Improving the existing code by adding the range limits, title, subtitle and theme.

```{r echo=TRUE, fig.height=10, fig.width=10, warning = FALSE, message = FALSE}

SG20 <- ggplot(summary_sex_20, aes(x=AG,colour=Sex,fill=Sex)) +
  geom_bar(data=summary_sex_20[summary_sex_20$Sex=="Males",], aes(y=Pop*-1), stat="identity") +
  geom_bar(data=summary_sex_20[summary_sex_20$Sex=="Females",], aes(y=Pop), stat="identity") +
  geom_hline(yintercept=0, colour="white", lwd=1) +
  
coord_flip() +
  
scale_y_continuous(limits = c(-170000, 170000), n.breaks = 10, labels = function(v) ifelse(abs(v)>= 1000,paste0(abs(v)/1000, "K"), abs(v))) +
  
  labs(title = "Singapore Age-Sex Population Pyramid for 20 years",
    subtitle = 'Year: "{round(frame_time, 0)}"',
    caption = 'Data Source: Department of Statistics (June 2000 to June 2020)',
  y = 'Male and Female Population',
  x = 'Age Group') +
  
  theme_bw () +
   theme(legend.text = element_text(size=12))+
  theme(plot.title = element_text(size=16))+
  theme(plot.subtitle = element_text(size=10))

SG20

```


### Animating the age-sex pyramid 
```{r echo=TRUE, fig.height=10, fig.width=10, warning = FALSE, message = FALSE}

SG20 +
transition_time(Time) +
ease_aes('linear')

```
### Doing Interactive plots

Interactive plots help to us compare the same point across 2 graphs

Loading packages for interactive plots

```{r echo = TRUE}  
packages = c('tidyverse', 'readxl', 'ggthemes', 'ggiraph', 'plotly', 
             'gganimate', 'patchwork', 'DT', 'gifski', 'gapminder')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

# Creating new data set for interactive plots
```{r echo = TRUE, warning = FALSE, message = FALSE}

interactive_data <- combined %>%
  spread (Sex, sum(Pop)) %>% 
  mutate(Total = Females + Males) %>% 
  group_by(Time, AG, PA) %>% 
  filter(PA == c("Ang Mo Kio", "Marine Parade")) %>% 
  summarise(Female = sum(Females), 
            Male =sum(Males), 
            Total = sum(Total)) 


interactive_data$AG <- factor(interactive_data$AG, levels = unique(interactive_data$AG))

interactive_data <- interactive_data %>% 
  mutate(Female_prop = Female / Total*100) %>% 
    mutate(Male_prop = Male / Total*100) 

head (interactive_data,5)

d <- highlight_key(interactive_data)


```

```{r echo=TRUE, fig.height=5, fig.width=10, warning = FALSE, message = FALSE}



p1 <- ggplot (data = d,
        aes(x = Time, 
            y = Total)) + 
  geom_col() +
  labs(title = 'Population across time in 2 Planning areas') +
facet_wrap(. ~ `PA`)
  
  p1
```

```{r echo=TRUE, warning = FALSE, message = FALSE}

p2 <- ggplot (data = d,
        aes(x =AG,
            y = Total)) + 
  geom_point() +
  labs(title = 'Total population across Age group in the Planning areas for 20 years')+
facet_wrap(. ~ `PA`) +
coord_flip()
  

p2
```

# Putting 2 graphs side by side

Try clicking on 1 graph to see where the point is on the next graph

```{r echo=TRUE, warning = FALSE, message = FALSE}

subplot (ggplotly (p1),
         ggplotly (p2))


```

# Linking graph with data table using crosstalk

Try clicking on the table to see where is the point in the graph

```{r echo=TRUE, warning = FALSE, message = FALSE}

Agegroup_PA <- combined %>% 
  group_by(AG, PA) %>% 
  summarise (Pop = sum (Pop))

d <- highlight_key(Agegroup_PA)

p3 <- ggplot (data = d, aes(x = AG, y = Pop))+ 
  geom_col () +
  ggtitle ("Age groups in Singapore's Planning Area",
subtitle = 'Planning Area: {PA}') +
  coord_flip()

```

```{r echo=TRUE, fig.height=15, fig.width=10, warning = FALSE, message = FALSE}

gg <- highlight(ggplotly(p3),
                "plotly_selected")

crosstalk::bscols(gg,
                  DT::datatable(d),
                  widths = 20)

```

# Animating graph by Singapore Planning Area and age group`

Plotting the graph to show the number of population across the age group by Planning area for 20 years (2000 - 2020). 

```{r echo=TRUE, fig.height=15, fig.width=10, message=FALSE, warning=FALSE}

animate1 <- ggplot (Agegroup_PA, aes(x = AG, y = Pop/1000))+ 
    geom_col () +
  coord_flip() +
ggtitle('Planning area: {closest_state}') +
  labs (x = 'AG',
        y = 'Population (thousand)') +
transition_states (PA) +
  ease_aes('linear') +
  enter_fade() +
  exit_fade()

animate(animate1,fps=2)

```